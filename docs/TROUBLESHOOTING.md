# ü©∫ TROUBLESHOOTING - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –µ—ë.  
**–§–æ–∫—É—Å:** —Ä–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã InteriorBot, –±–µ–∑ —Ç–µ–æ—Ä–∏–∏.  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** December 12, 2025  

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ú–µ—Ç–æ–¥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º](#–º–µ—Ç–æ–¥–∏–∫–∞-–ø–æ–∏—Å–∫–∞-–ø—Ä–æ–±–ª–µ–º)
2. [–¢–∏–ø–∏—á–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è](#—Ç–∏–ø–∏—á–Ω—ã–µ-—Å–∏–º–ø—Ç–æ–º—ã-–∏-—Ä–µ—à–µ–Ω–∏—è)
3. [–ü—Ä–æ–±–ª–µ–º—ã —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (Replicate)](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π-replicate)
4. [–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ (YooKassa)](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–ø–ª–∞—Ç–µ–∂–∞–º–∏-yookassa)
5. [–ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î (SQLite)](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–±–¥-sqlite)
6. [–ü—Ä–æ–±–ª–µ–º—ã —Å FSM –∏ –º–µ–Ω—é](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-fsm-–∏-–º–µ–Ω—é)
7. [–ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–º](#—á–µ–∫-–ª–∏—Å—Ç-–ø–µ—Ä–µ–¥-–ø—Ä–æ–¥–æ–º)

---

## üß≠ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –®–∞–≥ 1: –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–∏–º–ø—Ç–æ–º

–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:

```markdown
- –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç? (–∫–æ–º–∞–Ω–¥–∞, –∫–Ω–æ–ø–∫–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –æ–ø–ª–∞—Ç–∞)
- –≠—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤—Å–µ–≥–¥–∞ –∏–ª–∏ –∏–Ω–æ–≥–¥–∞?
- –£ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ —É –æ–¥–Ω–æ–≥–æ?
- –ü–æ—Å–ª–µ –∫–∞–∫–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤—Å—ë –ª–æ–º–∞–µ—Ç—Å—è?
```

### –®–∞–≥ 2: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –ª–æ–≥ –≤ —Ñ–∞–π–ª)
tail -n 100 bot.log

# –ß–µ—Ä–µ–∑ systemd
journalctl -u interiorbot -n 100 --no-pager

# –ß–µ—Ä–µ–∑ Docker
docker compose logs -n 100 interiorbot
```

–ò—â–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º:

```bash
grep -i "ERROR" bot.log
grep -i "Traceback" bot.log
grep -i "Replicate" bot.log
grep -i "YooKassa" bot.log
```

### –®–∞–≥ 3: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å —Ç–µ—Å—Ç–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

- –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ –≤ **debug-—Ä–µ–∂–∏–º–µ** (—Å–º. DEVELOPMENT_GUIDE).
- –ü–æ–≤—Ç–æ—Ä–∏ —à–∞–≥–∏ —Ä—É–∫–∞–º–∏.
- –°–º–æ—Ç—Ä–∏, –∫–∞–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∏ –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ state.data/–ë–î.

### –®–∞–≥ 4: –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å

–û–ø—Ä–µ–¥–µ–ª–∏ **–∏–∑ –∫–∞–∫–æ–≥–æ —Å–ª–æ—è** –ø—Ä–æ–±–ª–µ–º–∞:

```markdown
- handlers  ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π / callback_data / FSM
- services  ‚Üí Replicate –∏–ª–∏ YooKassa
- database  ‚Üí SQLite, –∑–∞–ø—Ä–æ—Å—ã, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- config    ‚Üí —Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏, ADMIN_IDS
```

---

## ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ /start

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å `/start`, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
- –õ–æ–≥–∏ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram.

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–æ—Ç –≤–æ–æ–±—â–µ –∑–∞–ø—É—â–µ–Ω
ps aux | grep bot/main.py

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ BOT_TOKEN
grep BOT_TOKEN .env

# 3. –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤ Telegram API
source venv/bin/activate
python - << 'PY'
import os, requests
from dotenv import load_dotenv
load_dotenv()

bot_token = os.getenv('BOT_TOKEN')
print("BOT_TOKEN:", bot_token[:15] + '...')

r = requests.get(f"https://api.telegram.org/bot{bot_token}/getMe")
print(r.status_code, r.text)
PY
```

**–¢–∏–ø–æ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

```markdown
1) –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π BOT_TOKEN
   - –°–∏–º–ø—Ç–æ–º: getMe –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 / 404
   - –†–µ—à–µ–Ω–∏–µ: –≤–∑—è—Ç—å —Ç–æ–∫–µ–Ω –∑–∞–Ω–æ–≤–æ —É @BotFather, –æ–±–Ω–æ–≤–∏—Ç—å .env, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞.

2) –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω
   - –°–∏–º–ø—Ç–æ–º: ps aux –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç bot/main.py
   - –†–µ—à–µ–Ω–∏–µ: –∑–∞–ø—É—Å—Ç–∏—Ç—å: `python bot/main.py` –∏–ª–∏ `systemctl start interiorbot`.

3) –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
   - –°–∏–º–ø—Ç–æ–º: –≤ –ª–æ–≥–∞—Ö —Å—Ä–∞–∑—É Traceback –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
   - –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É (–æ–±—ã—á–Ω–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å).
```

---

### 2. –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç (callback –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è)

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ inline-–∫–Ω–æ–ø–∫—É –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
- –í–Ω–∏–∑—É Telegram: `Bot hasn't been started` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–∏—à–∏–Ω–∞.

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

```markdown
- –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏: –ø—Ä–∏—Ö–æ–¥—è—Ç –ª–∏ callback_query —Å–æ–±—ã—Ç–∏—è?
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ callback_data —Ç–æ–º—É, —á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç —Ö–µ–Ω–¥–ª–µ—Ä?
- –ï—Å—Ç—å –ª–∏ –Ω—É–∂–Ω—ã–π @router.callback_query —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º F.data?
- –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ –¥—Ä—É–≥–æ–π —Ö–µ–Ω–¥–ª–µ—Ä —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ —Ä–∞–Ω—å—à–µ?
```

**–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:**

```python
# 1. –û—à–∏–±–∫–∞ –≤ callback_data
# –í –∫–Ω–æ–ø–∫–µ: callback_data="create_designs" (–ª–∏—à–Ω—è—è s)
# –í —Ö–µ–Ω–¥–ª–µ—Ä–µ: F.data == "create_design"

# –†–µ—à–µ–Ω–∏–µ: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É 1-–≤-1.

# 2. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç state –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–µ
@router.callback_query(F.data.startswith("style_"))  # ‚ùå

# –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–∏ choose_style,
# –∞ —Ö–µ–Ω–¥–ª–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω –ë–ï–ó state.

# –õ—É—á—à–µ —Ç–∞–∫:
@router.callback_query(F.data.startswith("style_"), state=CreationStates.choose_style)  # ‚úÖ
```

---

### 3. –ü–æ—Å–ª–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –æ–¥–Ω–æ "–≥–ª–∞–≤–Ω–æ–µ" —Å–æ–æ–±—â–µ–Ω–∏–µ, –±–æ—Ç —à–ª—ë—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω–∏–∑ —á–∞—Ç–∞.

**–í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- –ì–¥–µ-—Ç–æ –≤—ã–∑–≤–∞–Ω–æ `state.clear()` ‚Üí –ø–æ—Ç–µ—Ä—è–Ω `menu_message_id`.

**–ö–∞–∫ –Ω–∞–π—Ç–∏:**

```bash
grep -R "state.clear" -n bot/
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:**

```python
# –î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ –ú–ï–ù–Ø–ï–ú –¢–û–õ–¨–ö–û –°–û–°–¢–û–Ø–ù–ò–ï FSM
await state.set_state(None)  # ‚úÖ FSM —Å–±—Ä–æ—à–µ–Ω, menu_message_id —Å–æ—Ö—Ä–∞–Ω—ë–Ω

# –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—Å–µ—Ç–∞ (–æ—á–∏—Å—Ç–∏—Ç—å –í–°–Å, –≤–∫–ª—é—á–∞—è menu_message_id)
await state.clear()  # ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –¥–ª—è /start –∏–ª–∏ –∂—ë—Å—Ç–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞
```

–°–º–æ—Ç—Ä–∏ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ `DEVELOPMENT_RULES.md` –∏ `FSM_GUIDE.md`.

---

### 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏—Å–∏—Ç –∏–ª–∏ –ø–∞–¥–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –¥–æ–ª–≥–æ "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é..." –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
- –ò–ª–∏ –±—ã—Å—Ç—Ä–æ "‚ùå Generation failed".

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
grep -i "Replicate" bot.log
grep -i "generate_image" bot.log
```

**–¢–∏–ø–æ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

```markdown
1) REPLICATE_API_TOKEN –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
   - –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö: 401 / 403 –æ—Ç Replicate
   - –†–µ—à–µ–Ω–∏–µ: –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ https://replicate.com/account

2) –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / timeout
   - –û—à–∏–±–∫–∞: asyncio.TimeoutError –∏–ª–∏ httpx.TimeoutException
   - –†–µ—à–µ–Ω–∏–µ: —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

3) –ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è/–±–∏—Ç–∞—è)
   - –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è / –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫—É, –ø–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.
```

**–ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:**

```python
logger.info(f"Starting generation for user={user_id}, room={room}, style={style}")
logger.debug(f"photo_id={photo_id}")
```

---

### 5. –û–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è (check_payment –≤—Å–µ–≥–¥–∞ "–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ")

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç, –Ω–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–Ø –æ–ø–ª–∞—Ç–∏–ª" ‚Äî –≤—Å–µ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ "–û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" –∏–ª–∏ "–µ—â—ë –Ω–µ –ø–æ—Å—Ç—É–ø–∏–ª–∞".

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
grep -i "check_payment" bot.log
grep -i "YooKassa" bot.log
```

**–ß–∞—Å—Ç—ã–µ –∫–µ–π—Å—ã:**

```markdown
1) –í –ë–î –Ω–µ—Ç pending-–ø–ª–∞—Ç–µ–∂–∞
   - –ü—Ä–∏—á–∏–Ω–∞: create_payment() –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ SQLite:
     sqlite3 bot.db
     SELECT * FROM payments WHERE status='pending';

2) –ù–µ —Ç–æ—Ç payment_id –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ YooKassa
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å yookassa_payment_id –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ

3) YooKassa –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∞ –ø–ª–∞—Ç—ë–∂
   - –†–µ—à–µ–Ω–∏–µ: –ø–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–∂–∞—Ç—å "–Ø –æ–ø–ª–∞—Ç–∏–ª".

4) –ù–µ–≤–µ—Ä–Ω—ã–µ SHOP_ID / SECRET_KEY
   - –°–∏–º–ø—Ç–æ–º: –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Payment.find_one()
   - –†–µ—à–µ–Ω–∏–µ: —Å–≤–µ—Ä–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –≤ –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa.
```

---

### 6. –û—à–∏–±–∫–∏ –ë–î: "database is locked" / "unable to open database file"

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–∞–¥–µ–Ω–∏—è —Å `sqlite3.OperationalError`.

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
grep -i "database is locked" bot.log
grep -i "unable to open database" bot.log
```

**–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

```markdown
1) –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ bot.db
   - –†–µ—à–µ–Ω–∏–µ: –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å (–æ–¥–∏–Ω systemd —Å–µ—Ä–≤–∏—Å –∏–ª–∏ –æ–¥–∏–Ω docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä).

2) –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Ñ–∞–π–ª bot.db
   - –†–µ—à–µ–Ω–∏–µ:
     sudo chown $USER:$USER bot.db
     sudo chmod 600 bot.db

3) –û–±–æ—Ä–≤–∞–Ω–Ω—ã–µ WAL/SHM —Ñ–∞–π–ª—ã
   - –†–µ—à–µ–Ω–∏–µ:
     rm -f bot.db-wal bot.db-shm
```

---

## üß© –ü—Ä–æ–±–ª–µ–º—ã —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (Replicate)

### –û—à–∏–±–∫–∞: `replicate.error.ReplicateError`

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö —Å—Ç–µ–∫-—Ç—Ä–µ–π—Å –æ—Ç Replicate.

**–ü—Ä–∏—á–∏–Ω—ã:**

```markdown
- –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –º–æ–¥–µ–ª—å –∏–ª–∏ –≤–µ—Ä—Å–∏—è
- –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (image, prompt)
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–≤–æ—Ç—ã / –ª–∏–º–∏—Ç–æ–≤
```

**–†–µ—à–µ–Ω–∏—è:**

```markdown
1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª—å –∏ –≤–µ—Ä—Å–∏—é –≤ –∫–æ–¥–µ (services/replicate_api.py)
2) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ image –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ base64 data URL
3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –∏ –±–∏–ª–ª–∏–Ω–≥ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ Replicate
```

---

## üí≥ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ (YooKassa)

### –û—à–∏–±–∫–∞: `yookassa.exceptions.RequestError`

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Payment.create –∏–ª–∏ Payment.find_one.

**–ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

```markdown
- –ù–µ–≤–µ—Ä–Ω—ã–π SHOP_ID –∏–ª–∏ SECRET_KEY
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã (—Å—Ç—Ä–æ–∫–∞/float –≤–º–µ—Å—Ç–æ —Ü–µ–ª–æ–≥–æ)
- –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–∞–ª—é—Ç—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å RUB)
```

**–†–µ—à–µ–Ω–∏—è:**

```markdown
1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env –∏ config.py
2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ YooKassa –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å —Å –Ω–∞—à–∏–º
3) –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞
```

---

## üóÑ –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î (SQLite)

### –°–∏–º–ø—Ç–æ–º: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å / –±–∞–ª–∞–Ω—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
sqlite3 bot.db
.tables
SELECT * FROM users LIMIT 5;
SELECT * FROM payments LIMIT 5;
```

**–¢–∏–ø–∏—á–Ω—ã–µ –±–∞–≥–∏:**

```markdown
1) –ù–µ –≤—ã–∑–≤–∞–Ω init_db() –Ω–∞ –ø—Ä–æ–¥–µ
   - –†–µ—à–µ–Ω–∏–µ: –≤—ã–ø–æ–ª–Ω–∏—Ç—å Database.init_db()

2) –û—à–∏–±–∫–∞ –≤ SQL –∑–∞–ø—Ä–æ—Å–µ (models.py)
   - –°–∏–º–ø—Ç–æ–º: OperationalError –≤ –ª–æ–≥–∞—Ö
   - –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å SQL –≤—Ä—É—á–Ω—É—é –≤ sqlite3 CLI.

3) –ù–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –†–µ—à–µ–Ω–∏–µ: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ db.py –ø–æ—Å–ª–µ execute –µ—Å—Ç—å commit().
```

---

## üß© –ü—Ä–æ–±–ª–µ–º—ã —Å FSM –∏ –º–µ–Ω—é

### –°–∏–º–ø—Ç–æ–º: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã–µ –Ω–∞–∂–∞—Ç–∏—è –≤–µ–¥—É—Ç —Å–µ–±—è —Å—Ç—Ä–∞–Ω–Ω–æ.
- –í –ª–æ–≥–∞—Ö FSM state –≤—Å—ë –µ—â—ë `choose_style`.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ FSM:**

```python
fsm_state = await state.get_state()
logger.warning(f"FSM STATE = {fsm_state}")
```

**–†–µ—à–µ–Ω–∏–µ:**

```python
# –í –∫–æ–Ω—Ü–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –í–°–ï–ì–î–ê –≤—ã–∑—ã–≤–∞—Ç—å
await state.set_state(None)
```

### –°–∏–º–ø—Ç–æ–º: –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–º. —Ä–∞–∑–¥–µ–ª –ø—Ä–æ `state.clear()` –≤—ã—à–µ –∏ `DEVELOPMENT_RULES.md`.

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–º

```markdown
- [ ] /start —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω 10+ —Ä–∞–∑ –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–æ–≤
- [ ] –ü–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω—ã –≤ –±–æ–µ–≤–æ–º YooKassa (—Ç–µ—Å—Ç–æ–≤—ã–µ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ)
- [ ] –ë—ç–∫–∞–ø—ã bot.db –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (cron + –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
- [ ] DEBUG=false, LOG_LEVEL=INFO/ WARNING
- [ ] –û–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ .env –∏ bot.db
- [ ] systemd –∏–ª–∏ docker-–∫–æ–Ω—Ñ–∏–≥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ä–µ—Å—Ç–∞—Ä—Ç—ã
- [ ] –ê–¥–º–∏–Ω-–∞–∫–∫–∞—É–Ω—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω (ADMIN_IDS –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–∞: DEVELOPMENT_GUIDE, ARCHITECTURE, FSM_GUIDE
```

---

**Document Status:** ‚úÖ Complete  
**Last Updated:** December 12, 2025  
**Version:** 2.0 Professional
