# üìò –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê - –ü–û–õ–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

**–ü—Ä–æ–µ–∫—Ç:** InteriorBot-v2  
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** https://github.com/severand/InteriorBot-v2  
**–î–∞—Ç–∞:** 03.12.2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0

---

## üéØ –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è Telegram-–±–æ—Ç–∞ —Å:

‚úÖ **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º –¥—Ä—É–∑–µ–π** –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º** –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç –ø–æ–∫—É–ø–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤  
‚úÖ **–í—ã–≤–æ–¥–æ–º –¥–µ–Ω–µ–≥** –Ω–∞ –∫–∞—Ä—Ç—ã/–°–ë–ü/YooMoney/–¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã  
‚úÖ **–û–±–º–µ–Ω–æ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞** –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏  
‚úÖ **–ü–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π** (–∑–∞—Ä–∞–±–æ—Ç–∫–∏, –æ–±–º–µ–Ω—ã, –≤—ã–ø–ª–∞—Ç—ã)  
‚úÖ **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
InteriorBot-v2/
‚îî‚îÄ‚îÄ bot/
    ‚îú‚îÄ‚îÄ config.py                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (BOT_USERNAME)
    ‚îú‚îÄ‚îÄ main.py                      # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
    ‚îú‚îÄ‚îÄ database/
    ‚îÇ   ‚îú‚îÄ‚îÄ models.py                # SQL-—Å—Ö–µ–º—ã –∏ –∑–∞–ø—Ä–æ—Å—ã
    ‚îÇ   ‚îî‚îÄ‚îÄ db.py                    # –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –ë–î
    ‚îú‚îÄ‚îÄ handlers/
    ‚îÇ   ‚îú‚îÄ‚îÄ user_start.py            # –ü—Ä–æ—Ñ–∏–ª—å + —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ
    ‚îÇ   ‚îú‚îÄ‚îÄ payment.py               # –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ % –æ—Ç –ø–æ–∫—É–ø–æ–∫
    ‚îÇ   ‚îú‚îÄ‚îÄ referral.py              # –í—ã–ø–ª–∞—Ç—ã, –æ–±–º–µ–Ω—ã, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã, –∏—Å—Ç–æ—Ä–∏—è
    ‚îÇ   ‚îî‚îÄ‚îÄ admin.py                 # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç–∞–º–∏)
    ‚îú‚îÄ‚îÄ keyboards/
    ‚îÇ   ‚îî‚îÄ‚îÄ inline.py                # –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏
    ‚îú‚îÄ‚îÄ states/
    ‚îÇ   ‚îî‚îÄ‚îÄ fsm.py                   # ReferralStates, AdminStates
    ‚îî‚îÄ‚îÄ utils/
        ‚îî‚îÄ‚îÄ texts.py                 # PROFILE_WITH_REFERRAL_TEXT
```

---

## üóÑÔ∏è –ë–ê–ó–ê –î–ê–ù–ù–´–•

### 1. –¢–∞–±–ª–∏—Ü–∞ `users` (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è)

#### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è:
```sql
user_id INTEGER PRIMARY KEY
username TEXT
balance INTEGER DEFAULT 3                    -- –±–∞–ª–∞–Ω—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
reg_date DATETIME DEFAULT CURRENT_TIMESTAMP
```

#### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:
```sql
referral_code TEXT UNIQUE                    -- —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (8 —Å–∏–º–≤–æ–ª–æ–≤)
referred_by INTEGER                          -- ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª)
referrals_count INTEGER DEFAULT 0            -- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö
```

#### –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–ª—è:
```sql
referral_balance INTEGER DEFAULT 0           -- –±–∞–ª–∞–Ω—Å –≤ —Ä—É–±–ª—è—Ö (–¥–ª—è –≤—ã–≤–æ–¥–∞)
referral_total_earned INTEGER DEFAULT 0      -- –≤—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ (—Ä—É–±–ª–∏)
referral_total_paid INTEGER DEFAULT 0        -- –≤—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ (—Ä—É–±–ª–∏)
```

#### –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–ø–ª–∞—Ç:
```sql
payment_method TEXT                          -- —Å–ø–æ—Å–æ–±: card/sbp/yoomoney/other
payment_details TEXT                         -- –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/—Ç–µ–ª–µ—Ñ–æ–Ω–∞/–∫–æ—à–µ–ª—å–∫–∞
sbp_bank TEXT                                -- –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –¥–ª—è –°–ë–ü
```

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
```sql
total_generations INTEGER DEFAULT 0          -- –≤—Å–µ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —Å–¥–µ–ª–∞–Ω–æ
successful_payments INTEGER DEFAULT 0        -- —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–ª–∞—Ç
total_spent INTEGER DEFAULT 0                -- –≤—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ (—Ä—É–±–ª–∏)
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ï—Å–ª–∏ –±–∞–∑–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è —á–µ—Ä–µ–∑ ALTER TABLE.

---

### 2. –¢–∞–±–ª–∏—Ü–∞ `referral_earnings` (–ù–û–í–ê–Ø)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä—É

```sql
CREATE TABLE IF NOT EXISTS referral_earnings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    referrer_id INTEGER NOT NULL,              -- –∫—Ç–æ –ø–æ–ª—É—á–∏–ª –∫–æ–º–∏—Å—Å–∏—é
    referred_id INTEGER NOT NULL,              -- –∫—Ç–æ —Å–æ–≤–µ—Ä—à–∏–ª –ø–æ–∫—É–ø–∫—É
    payment_id TEXT NOT NULL,                  -- ID –ø–ª–∞—Ç–µ–∂–∞ –≤ payments
    amount INTEGER NOT NULL,                   -- —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ (—Ä—É–±–ª–∏)
    commission_percent INTEGER NOT NULL,       -- –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ (10%)
    earnings INTEGER NOT NULL,                 -- –∑–∞—Ä–∞–±–æ—Ç–æ–∫ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (—Ä—É–±–ª–∏)
    tokens_given INTEGER NOT NULL,             -- –±–æ–Ω—É—Å–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
    status TEXT DEFAULT 'credited',            -- —Å—Ç–∞—Ç—É—Å: credited/cancelled
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_id) REFERENCES users (user_id),
    FOREIGN KEY (referred_id) REFERENCES users (user_id)
)
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:**
```
referrer_id: 123456
referred_id: 789012
payment_id: "yookassa_abc123"
amount: 990 —Ä—É–± (–ø–æ–∫—É–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞)
commission_percent: 10
earnings: 99 —Ä—É–± (10% –æ—Ç 990)
tokens_given: 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (99 —Ä—É–± / 29 —Ä—É–± –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é)
```

---

### 3. –¢–∞–±–ª–∏—Ü–∞ `referral_exchanges` (–ù–û–í–ê–Ø)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–º–µ–Ω–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```sql
CREATE TABLE IF NOT EXISTS referral_exchanges (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    amount INTEGER NOT NULL,                   -- —Å—É–º–º–∞ –æ–±–º–µ–Ω–∞ (—Ä—É–±–ª–∏)
    tokens INTEGER NOT NULL,                   -- –ø–æ–ª—É—á–µ–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
    exchange_rate INTEGER NOT NULL,            -- –∫—É—Ä—Å –æ–±–º–µ–Ω–∞ (29 —Ä—É–±/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (user_id)
)
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:**
```
user_id: 123456
amount: 290 —Ä—É–±
tokens: 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
exchange_rate: 29 —Ä—É–±/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```

---

### 4. –¢–∞–±–ª–∏—Ü–∞ `referral_payouts` (–ù–û–í–ê–Ø)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞

```sql
CREATE TABLE IF NOT EXISTS referral_payouts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    amount INTEGER NOT NULL,                   -- —Å—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã
    payment_method TEXT,                       -- card/sbp/yoomoney/other
    payment_details TEXT,                      -- —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
    status TEXT DEFAULT 'pending',             -- pending/completed/rejected
    admin_note TEXT,                           -- –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    requested_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    processed_at DATETIME,                     -- –∫–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
    processed_by INTEGER,                      -- ID –∞–¥–º–∏–Ω–∞
    FOREIGN KEY (user_id) REFERENCES users (user_id)
)
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `pending` - –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `completed` - –≤—ã–ø–ª–∞—á–µ–Ω–æ
- `rejected` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ

---

### 5. –¢–∞–±–ª–∏—Ü–∞ `settings` (–¥–æ–ø–æ–ª–Ω–µ–Ω–∞)

**–ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã:**

| –ö–ª—é—á | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------------------|----------|
| `welcome_bonus` | `"3"` | –ë–æ–Ω—É—Å –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏) |
| `referral_bonus_inviter` | `"2"` | –ë–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏) |
| `referral_bonus_invited` | `"2"` | –ë–æ–Ω—É—Å –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏) |
| `referral_enabled` | `"1"` | –í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ (1/0) |
| `referral_commission_percent` | `"10"` | –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –ø–æ–∫—É–ø–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (%) |
| `referral_min_payout` | `"500"` | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (—Ä—É–±–ª–∏) |
| `referral_exchange_rate` | `"29"` | –ö—É—Ä—Å –æ–±–º–µ–Ω–∞ —Ä—É–±–ª–∏ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Ä—É–±/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) |

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–µ—Ä–µ–∑ –∫–æ–¥:**
```python
await db.set_setting("referral_commission_percent", "15")  # –ü–æ–º–µ–Ω—è—Ç—å –Ω–∞ 15%
await db.set_setting("referral_min_payout", "1000")        # –ú–∏–Ω. –≤—ã–≤–æ–¥ 1000 —Ä—É–±
```

---

## üîÑ –°–•–ï–ú–ê –†–ê–ë–û–¢–´ –°–ò–°–¢–ï–ú–´

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É:**
```
1. –†–µ—Ñ–µ—Ä–µ—Ä –∫–æ–ø–∏—Ä—É–µ—Ç —Å–≤–æ—é —Å—Å—ã–ª–∫—É: t.me/YourBot?start=ref_ABC12345
2. –î—Ä—É–≥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí /start ref_ABC12345
3. –ë–æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ù–∞—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å—ã –û–ë–û–ò–ú:
   - –†–µ—Ñ–µ—Ä–µ—Ä: +2 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (referral_bonus_inviter)
   - –ù–æ–≤—ã–π: +2 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (referral_bonus_invited)
```

**–ö–æ–¥ –≤ user_start.py:**
```python
@router.message(Command("start"))
async def start_command(message: Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –ü–∞—Ä—Å–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
    referrer_code = None
    if len(message.text.split()) > 1:
        args = message.text.split()[1]
        if args.startswith('ref_'):
            referrer_code = args.replace('ref_', '')
    
    # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
    await db.create_user(user_id, message.from_user.username, referrer_code)
```

**–ö–æ–¥ –≤ db.py:**
```python
async def create_user(self, user_id: int, username: str, referrer_code: str):
    # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–∞—á–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
    await db.execute(CREATE_USER, (user_id, username, initial_balance))
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ (8 —Å–∏–º–≤–æ–ª–æ–≤)
    import secrets
    ref_code = secrets.token_urlsafe(8)
    await db.execute(UPDATE_REFERRAL_CODE, (ref_code, user_id))
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É
    if referrer_code:
        await self.process_referral(user_id, referrer_code)
```

---

### 2. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç –ø–æ–∫—É–ø–æ–∫

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É:**
```
1. –†–µ—Ñ–µ—Ä–∞–ª –ø–æ–∫—É–ø–∞–µ—Ç –ø–∞–∫–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 60 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∑–∞ 990 —Ä—É–±)
2. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:
   - –†–µ—Ñ–µ—Ä–∞–ª –ø–æ–ª—É—á–∞–µ—Ç 60 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
   - –†–µ—Ñ–µ—Ä–µ—Ä—É –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è:
     a) 99 —Ä—É–± –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (10% –æ—Ç 990)
     b) 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å (99 / 29 = 3)
3. –û–ø–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ referral_earnings
```

**–ö–æ–¥ –≤ payment.py:**
```python
@router.callback_query(F.data == "check_payment")
async def check_payment(callback: CallbackQuery):
    # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
    if is_paid:
        # 1. –ù–∞—á–∏—Å–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
        await db.add_tokens(user_id, last_payment['tokens'])
        
        # 2. –ù–∞—á–∏—Å–ª—è–µ–º –∫–æ–º–∏—Å—Å–∏—é —Ä–µ—Ñ–µ—Ä–µ—Ä—É
        await _process_referral_commission(
            user_id=user_id,
            payment_id=last_payment['yookassa_payment_id'],
            amount=last_payment['amount'],
            purchased_tokens=last_payment['tokens']
        )
```

**–§—É–Ω–∫—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≤ payment.py:**
```python
async def _process_referral_commission(user_id, payment_id, amount, purchased_tokens):
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞
    enabled = await db.get_setting("referral_enabled")
    if str(enabled) != "1":
        return
    
    # 2. –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
    user = await db.get_user_data(user_id)
    referrer_id = user.get("referred_by")
    if not referrer_id:
        return
    
    # 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é
    commission_percent = int(await db.get_setting("referral_commission_percent") or "10")
    earnings = int(amount * commission_percent / 100)
    
    # 4. –ù–∞—á–∏—Å–ª—è–µ–º —Ä—É–±–ª–∏ –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
    await db.add_referral_balance(referrer_id, earnings)
    
    # 5. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    exchange_rate = int(await db.get_setting("referral_exchange_rate") or "29")
    tokens_to_give = earnings // exchange_rate
    
    if tokens_to_give > 0:
        await db.add_tokens(referrer_id, tokens_to_give)
    
    # 6. –õ–æ–≥–∏—Ä—É–µ–º
    await db.log_referral_earning(
        referrer_id=referrer_id,
        referred_id=user_id,
        payment_id=payment_id,
        amount=amount,
        commission_percent=commission_percent,
        earnings=earnings,
        tokens=tokens_to_give
    )
```

---

### 3. –û–±–º–µ–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ: "üíé –û–±–º–µ–Ω—è—Ç—å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
2. –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å –∏ –∫—É—Ä—Å: 290 —Ä—É–± = 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
3. –í–≤–æ–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏–ª–∏ /all
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–±–º–µ–Ω
5. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
```

**–ö–æ–¥ –≤ referral.py:**
```python
@router.callback_query(F.data == "referral_exchange_tokens")
async def exchange_to_tokens(callback: CallbackQuery, state: FSMContext):
    balance = await db.get_referral_balance(user_id)
    exchange_rate = int(await db.get_setting("referral_exchange_rate") or "29")
    max_tokens = balance // exchange_rate
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    await state.set_state(ReferralStates.entering_exchange_amount)

@router.message(ReferralStates.entering_exchange_amount)
async def process_exchange_amount(message: Message, state: FSMContext):
    tokens = int(message.text)  # –∏–ª–∏ /all
    cost = tokens * exchange_rate
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–º–µ–Ω
    await db.decrease_referral_balance(user_id, cost)
    await db.increase_balance(user_id, tokens)
    
    # –õ–æ–≥–∏—Ä—É–µ–º
    await db.log_referral_exchange(user_id, cost, tokens, exchange_rate)
```

---

### 4. –ó–∞–ø—Ä–æ—Å –≤—ã–ø–ª–∞—Ç—ã

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "üí∏ –í—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏"
2. –ü—Ä–æ–≤–µ—Ä–∫–∏:
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ ‚â• 500 —Ä—É–±
   - –†–µ–∫–≤–∏–∑–∏—Ç—ã —É–∫–∞–∑–∞–Ω—ã
3. –í–≤–æ–¥–∏—Ç —Å—É–º–º—É –∏–ª–∏ /all
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞—è–≤–∫—É
5. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ referral_payouts —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
6. –ë–∞–ª–∞–Ω—Å –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è (—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É)
7. –ê–¥–º–∏–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞—è–≤–∫—É –≤—Ä—É—á–Ω—É—é
```

**–ö–æ–¥ –≤ referral.py:**
```python
@router.callback_query(F.data == "referral_request_payout")
async def request_payout(callback: CallbackQuery, state: FSMContext):
    balance = await db.get_referral_balance(user_id)
    min_payout = int(await db.get_setting("referral_min_payout") or "500")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    if balance < min_payout:
        await callback.answer("‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤")
        return
    
    payment_details = await db.get_payment_details(user_id)
    if not payment_details:
        await callback.answer("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã")
        return
    
    await state.set_state(ReferralStates.entering_payout_amount)

@router.callback_query(F.data.startswith("confirm_payout_"))
async def confirm_payout(callback: CallbackQuery):
    amount = int(callback.data.split("_")[-1])
    
    # –°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É
    payout_id = await db.create_payout_request(user_id, amount, method, details)
    
    # –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
    await db.decrease_referral_balance(user_id, amount)
```

---

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–ø–æ—Å–æ–±—ã:**

| –°–ø–æ—Å–æ–± | payment_method | –§–æ—Ä–º–∞—Ç payment_details | –í–∞–ª–∏–¥–∞—Ü–∏—è |
|--------|---------------|----------------------|-----------|
| –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ | `card` | 16-19 —Ü–∏—Ñ—Ä –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ | 16-19 —Ü–∏—Ñ—Ä |
| –°–ë–ü (–ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É) | `sbp` | +7XXXXXXXXXX | 12 —Å–∏–º–≤–æ–ª–æ–≤ |
| YooMoney | `yoomoney` | 11-15 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞ –∫–æ—à–µ–ª—å–∫–∞ | 11-15 —Ü–∏—Ñ—Ä |
| –î—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± | `other` | –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç | –ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤ |

**–ö–æ–¥ –≤ referral.py:**
```python
@router.callback_query(F.data == "referral_setup_payment")
async def setup_payment_method(callback: CallbackQuery):
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞
    keyboard = [
        [Button("üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞", "payment_method_card")],
        [Button("üì± –°–ë–ü", "payment_method_sbp")],
        [Button("üíµ YooMoney", "payment_method_yoomoney")],
        [Button("üí∞ –î—Ä—É–≥–æ–π", "payment_method_other")]
    ]

# –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ —Å–≤–æ–π handler
@router.callback_query(F.data == "payment_method_card")
async def setup_card(callback, state):
    await state.set_state(ReferralStates.entering_card_number)

@router.message(ReferralStates.entering_card_number)
async def process_card_number(message, state):
    card = re.sub(r'[^\d]', '', message.text)  # –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    await db.set_payment_details(user_id, "card", card)
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ referral.py:**
```python
def validate_phone(phone: str) -> tuple[bool, str]:
    # –£–±–∏—Ä–∞–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ +
    phone = re.sub(r'[^\d+]', '', phone)
    
    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ +7
    if phone.startswith('8'):
        phone = '+7' + phone[1:]
    elif phone.startswith('7'):
        phone = '+' + phone
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å +7XXXXXXXXXX = 12 —Å–∏–º–≤–æ–ª–æ–≤)
    if len(phone) != 12:
        return False, ""
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º: +7 (999) 123-45-67
    formatted = f"+7 ({phone[2:5]}) {phone[5:8]}-{phone[8:10]}-{phone[10:]}"
    return True, formatted
```

---

## üé® –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –ò–ù–¢–ï–†–§–ï–ô–°

### –ü—Ä–æ—Ñ–∏–ª—å —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

**–¢–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è (utils/texts.py):**
```python
PROFILE_WITH_REFERRAL_TEXT = (
    "üë§ **–í–ê–® –ü–†–û–§–ò–õ–¨**\n\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
    "üéØ **–ë–∞–ª–∞–Ω—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:** {balance}\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
    "üéÅ **–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞:**\n"
    "üîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞: `{referral_link}`\n"
    "üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: **{referrals_count}** {referrals_word}\n\n"
    "üí∞ **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:**\n"
    "‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: **{referral_balance} —Ä—É–±.**\n"
    "‚Ä¢ –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: {total_earned} —Ä—É–±.\n"
    "‚Ä¢ –í—ã–ø–ª–∞—á–µ–Ω–æ: {total_paid} —Ä—É–±.\n\n"
    "üéØ **–í–∞—à–∏ —É—Å–ª–æ–≤–∏—è:**\n"
    "‚Ä¢ –ó–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é: +2 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\n"
    "‚Ä¢ % –æ—Ç –ø–æ–∫—É–ø–æ–∫: {commission_percent}%\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
)
```

**–ö–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (keyboards/inline.py):**
```python
def get_profile_keyboard() -> InlineKeyboardMarkup:
    builder.row(
        InlineKeyboardButton(text="üí≥ –ö—É–ø–∏—Ç—å —Ç–æ–∫–µ–Ω—ã", callback_data="buy_generations")
    )
    builder.row(
        InlineKeyboardButton(text="üí∏ –í—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏", callback_data="referral_request_payout"),
        InlineKeyboardButton(text="üíé –û–±–º–µ–Ω—è—Ç—å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏", callback_data="referral_exchange_tokens")
    )
    builder.row(
        InlineKeyboardButton(text="‚öôÔ∏è –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–ø–ª–∞—Ç", callback_data="referral_setup_payment")
    )
    builder.row(
        InlineKeyboardButton(text="üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π", callback_data="referral_history")
    )
    builder.row(
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    )
```

**–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ user_start.py:**
```python
@router.callback_query(F.data == "menu_profile")
async def profile_callback(callback: CallbackQuery, state: FSMContext):
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    balance = await db.get_balance(user_id)
    user_data = await db.get_user(user_id)
    referral_code = user_data.get('referral_code', '')
    referrals_count = user_data.get('referrals_count', 0)
    referral_balance = await db.get_referral_balance(user_id)
    total_earned = user_data.get('referral_total_earned', 0) or 0
    total_paid = user_data.get('referral_total_paid', 0) or 0
    commission_percent = await db.get_setting("referral_commission_percent") or "10"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
    bot_username = config.BOT_USERNAME.replace('@', '')
    referral_link = f"t.me/{bot_username}?start=ref_{referral_code}"
    
    # –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ
    referrals_word = get_word_form(referrals_count, ("–¥—Ä—É–≥", "–¥—Ä—É–≥–∞", "–¥—Ä—É–∑–µ–π"))
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    profile_text = PROFILE_WITH_REFERRAL_TEXT.format(
        balance=balance,
        referral_link=referral_link,
        referrals_count=referrals_count,
        referrals_word=referrals_word,
        referral_balance=format_number(referral_balance),
        total_earned=format_number(total_earned),
        total_paid=format_number(total_paid),
        commission_percent=commission_percent
    )
```

---

## üîå –ú–ï–¢–û–î–´ DATABASE API

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ (db.py)

**–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```python
# –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
await db.create_user(user_id, username, referrer_code=None)

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
user = await db.get_user(user_id)

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É
referrer = await db.get_user_by_referral_code("ABC12345")

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_data = await db.get_user_data(user_id)
```

**–†–∞–±–æ—Ç–∞ —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º:**
```python
# –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (—Ä—É–±–ª–∏)
balance = await db.get_referral_balance(user_id)

# –î–æ–±–∞–≤–∏—Ç—å –∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–º—É –±–∞–ª–∞–Ω—Å—É
await db.add_referral_balance(user_id, amount=99)

# –£–º–µ–Ω—å—à–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
await db.decrease_referral_balance(user_id, amount=500)

# –ü–æ–ª—É—á–∏—Ç—å –æ–±—â–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫
total_earned = await db.get_user_total_earned(user_id)
```

**–†–∞–±–æ—Ç–∞ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–º–∏:**
```python
# –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
balance = await db.get_balance(user_id)

# –î–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
await db.add_tokens(user_id, tokens=10)
await db.increase_balance(user_id, amount=10)  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

# –£–º–µ–Ω—å—à–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
await db.decrease_balance(user_id)  # -1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π:**
```python
# –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ä–∞–±–æ—Ç–æ–∫ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
await db.log_referral_earning(
    referrer_id=123456,
    referred_id=789012,
    payment_id="yookassa_abc",
    amount=990,
    commission_percent=10,
    earnings=99,
    tokens_given=3
)

# –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ–±–º–µ–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
await db.log_referral_exchange(
    user_id=123456,
    amount=290,
    tokens=10,
    exchange_rate=29
)

# –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–ø–ª–∞—Ç—É
payout_id = await db.create_payout_request(
    user_id=123456,
    amount=1000,
    payment_method="sbp",
    payment_details="+79991234567"
)
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏:**
```python
# –ò—Å—Ç–æ—Ä–∏—è –∑–∞—Ä–∞–±–æ—Ç–∫–æ–≤
earnings = await db.get_user_referral_earnings(user_id)

# –ò—Å—Ç–æ—Ä–∏—è –æ–±–º–µ–Ω–æ–≤
exchanges = await db.get_user_exchanges(user_id)

# –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç
payouts = await db.get_user_payouts(user_id)
```

**–†–∞–±–æ—Ç–∞ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏:**
```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
await db.set_payment_details(user_id, "sbp", "+79991234567", sbp_bank="–°–±–µ—Ä–±–∞–Ω–∫")

# –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
details = await db.get_payment_details(user_id)
```

**–†–∞–±–æ—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:**
```python
# –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
value = await db.get_setting("referral_commission_percent")

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
await db.set_setting("referral_commission_percent", "15")

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
all_settings = await db.get_all_settings()
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
stats = await db.get_total_referral_stats()

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–º–µ–Ω–æ–≤
exchange_stats = await db.get_total_exchanges_stats()

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–ª–∞—Ç
payout_stats = await db.get_payout_stats()
```

---

## üõ†Ô∏è FSM STATES

### ReferralStates (states/fsm.py)

```python
class ReferralStates(StatesGroup):
    entering_payout_amount = State()      # –í–≤–æ–¥ —Å—É–º–º—ã –≤—ã–ø–ª–∞—Ç—ã
    entering_exchange_amount = State()    # –í–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
    entering_card_number = State()        # –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    entering_yoomoney = State()           # –í–≤–æ–¥ YooMoney
    entering_phone = State()              # –í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –°–ë–ü
    entering_other_method = State()       # –í–≤–æ–¥ –¥—Ä—É–≥–æ–≥–æ —Å–ø–æ—Å–æ–±–∞
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
await state.set_state(ReferralStates.entering_payout_amount)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
current = await state.get_state()
if current == ReferralStates.entering_phone:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
```

---

## üìã CALLBACK DATA

### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ callback_data

| Callback Data | Handler | –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------------|---------|------|----------|
| `referral_request_payout` | `request_payout()` | referral.py | –ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–ø–ª–∞—Ç—ã |
| `referral_exchange_tokens` | `exchange_to_tokens()` | referral.py | –ù–∞—á–∞–ª–æ –æ–±–º–µ–Ω–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| `referral_setup_payment` | `setup_payment_method()` | referral.py | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ |
| `referral_history` | `show_referral_history()` | referral.py | –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π |
| `payment_method_card` | `setup_card()` | referral.py | –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã |
| `payment_method_sbp` | `setup_sbp()` | referral.py | –ü—Ä–∏–≤—è–∑–∫–∞ –°–ë–ü |
| `payment_method_yoomoney` | `setup_yoomoney()` | referral.py | –ü—Ä–∏–≤—è–∑–∫–∞ YooMoney |
| `payment_method_other` | `setup_other()` | referral.py | –î—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± |
| `confirm_exchange_{tokens}` | `confirm_exchange()` | referral.py | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ |
| `confirm_payout_{amount}` | `confirm_payout()` | referral.py | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã |
| `show_profile` | `show_profile_handler()` | user_start.py | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å |

---

## ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### config.py

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:**
```python
class Config:
    BOT_USERNAME = os.getenv('BOT_USERNAME', 'YourBotUsername')  # –î–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ .env:**
```env
BOT_USERNAME=your_bot_username  # –ë–ï–ó @
```

**–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏:**
```python
bot_username = config.BOT_USERNAME.replace('@', '')
referral_link = f"t.me/{bot_username}?start=ref_{referral_code}"
```

---

## üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –í–ê–õ–ò–î–ê–¶–ò–Ø

### –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤

**–ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏:**
```python
# –ö–∞—Ä—Ç–∞: 1234 5678 9012 3456 ‚Üí 1234 **** **** 3456
if method == 'card' and len(details) >= 16:
    masked = f"{details[:4]} {'*' * 4} {'*' * 4} {details[-4:]}"

# –¢–µ–ª–µ—Ñ–æ–Ω: +79991234567 ‚Üí +7 (999) ***-**-67
elif method == 'sbp' and len(details) >= 10:
    masked = f"+7 ({details[2:5]}) ***-**-{details[-2:]}"

# –î—Ä—É–≥–æ–µ: –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ + ***
else:
    masked = details[:10] + '***' if len(details) > 10 else details
```

---

## üîÑ –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –î–ê–ù–ù–´–•

### –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

**1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```sql
-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
INSERT INTO users (user_id, username, balance) VALUES (789012, 'newuser', 3)

-- –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
UPDATE users SET referral_code = 'qwer5678' WHERE user_id = 789012

-- –®–∞–≥ 3: –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä (–∫–æ–¥ ref_ABC12345)
-- 3a. –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
SELECT * FROM users WHERE referral_code = 'ABC12345'  -- user_id = 123456

-- 3b. –°–≤—è–∑—ã–≤–∞–µ–º
UPDATE users SET referred_by = 123456 WHERE user_id = 789012

-- 3c. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
UPDATE users SET referrals_count = referrals_count + 1 WHERE user_id = 123456

-- 3d. –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å—ã
UPDATE users SET balance = balance + 2 WHERE user_id = 123456  -- —Ä–µ—Ñ–µ—Ä–µ—Ä
UPDATE users SET balance = balance + 2 WHERE user_id = 789012  -- –Ω–æ–≤—ã–π
```

**2. –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º:**
```sql
-- –®–∞–≥ 1: –†–µ—Ñ–µ—Ä–∞–ª –ø–æ–∫—É–ø–∞–µ—Ç 60 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∑–∞ 990 —Ä—É–±
INSERT INTO payments (user_id, yookassa_payment_id, amount, tokens, status)
VALUES (789012, 'yookassa_xyz', 990, 60, 'pending')

-- –®–∞–≥ 2: –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
UPDATE payments SET status = 'succeeded' WHERE yookassa_payment_id = 'yookassa_xyz'

-- –®–∞–≥ 3: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—É
UPDATE users SET balance = balance + 60 WHERE user_id = 789012

-- –®–∞–≥ 4: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä—É (10% –æ—Ç 990 = 99 —Ä—É–±)
-- 4a. –†—É–±–ª–∏ –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
UPDATE users SET 
    referral_balance = referral_balance + 99,
    referral_total_earned = referral_total_earned + 99
WHERE user_id = 123456

-- 4b. –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å (99/29 = 3)
UPDATE users SET balance = balance + 3 WHERE user_id = 123456

-- 4c. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
INSERT INTO referral_earnings 
(referrer_id, referred_id, payment_id, amount, commission_percent, earnings, tokens_given)
VALUES (123456, 789012, 'yookassa_xyz', 990, 10, 99, 3)
```

**3. –û–±–º–µ–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
```sql
-- –†–µ—Ñ–µ—Ä–µ—Ä –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç 290 —Ä—É–± –Ω–∞ 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
-- –®–∞–≥ 1: –£–º–µ–Ω—å—à–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
UPDATE users SET referral_balance = referral_balance - 290 WHERE user_id = 123456

-- –®–∞–≥ 2: –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
UPDATE users SET balance = balance + 10 WHERE user_id = 123456

-- –®–∞–≥ 3: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
INSERT INTO referral_exchanges (user_id, amount, tokens, exchange_rate)
VALUES (123456, 290, 10, 29)
```

**4. –ó–∞–ø—Ä–æ—Å –≤—ã–ø–ª–∞—Ç—ã:**
```sql
-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
INSERT INTO referral_payouts (user_id, amount, payment_method, payment_details)
VALUES (123456, 1000, 'sbp', '+79991234567')

-- –®–∞–≥ 2: –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
UPDATE users SET referral_balance = referral_balance - 1000 WHERE user_id = 123456

-- –®–∞–≥ 3: –ê–¥–º–∏–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞—è–≤–∫—É
UPDATE referral_payouts 
SET status = 'completed', processed_at = CURRENT_TIMESTAMP, processed_by = 7884972750
WHERE id = 42

-- –®–∞–≥ 4: –û–±–Ω–æ–≤–ª—è–µ–º total_paid
UPDATE users SET referral_total_paid = referral_total_paid + 1000 WHERE user_id = 123456
```

---

## üéÆ HANDLERS FLOW

### –ö–∞—Ä—Ç–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ü–†–û–§–ò–õ–¨ (user_start.py)                     ‚îÇ
‚îÇ  Callback: menu_profile                             ‚îÇ
‚îÇ  ‚Üì                                                   ‚îÇ
‚îÇ  –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é                  ‚îÇ
‚îÇ  + 4 –∫–Ω–æ–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚îú‚îÄ‚îÄ‚Üí üí∏ –í—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏
          ‚îÇ    ‚îÇ
          ‚îÇ    ‚îî‚îÄ‚îÄ‚Üí referral.py: request_payout()
          ‚îÇ         ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞
          ‚îÇ         ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
          ‚îÇ         ‚îî‚îÄ ReferralStates.entering_payout_amount
          ‚îÇ              ‚îî‚îÄ process_payout_amount()
          ‚îÇ                   ‚îî‚îÄ confirm_payout()
          ‚îÇ
          ‚îú‚îÄ‚îÄ‚Üí üíé –û–±–º–µ–Ω—è—Ç—å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
          ‚îÇ    ‚îÇ
          ‚îÇ    ‚îî‚îÄ‚îÄ‚Üí referral.py: exchange_to_tokens()
          ‚îÇ         ‚îú‚îÄ –†–∞—Å—á—ë—Ç –º–∞–∫—Å–∏–º—É–º–∞
          ‚îÇ         ‚îî‚îÄ ReferralStates.entering_exchange_amount
          ‚îÇ              ‚îî‚îÄ process_exchange_amount()
          ‚îÇ                   ‚îî‚îÄ confirm_exchange()
          ‚îÇ
          ‚îú‚îÄ‚îÄ‚Üí ‚öôÔ∏è –†–µ–∫–≤–∏–∑–∏—Ç—ã
          ‚îÇ    ‚îÇ
          ‚îÇ    ‚îî‚îÄ‚îÄ‚Üí referral.py: setup_payment_method()
          ‚îÇ         ‚îú‚îÄ payment_method_card ‚Üí setup_card()
          ‚îÇ         ‚îú‚îÄ payment_method_sbp ‚Üí setup_sbp()
          ‚îÇ         ‚îú‚îÄ payment_method_yoomoney ‚Üí setup_yoomoney()
          ‚îÇ         ‚îî‚îÄ payment_method_other ‚Üí setup_other()
          ‚îÇ
          ‚îî‚îÄ‚îÄ‚Üí üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
               ‚îÇ
               ‚îî‚îÄ‚îÄ‚Üí referral.py: show_referral_history()
                    ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç earnings
                    ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç exchanges
                    ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç payouts
                    ‚îî‚îÄ –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—ã–≤–æ–¥
```

### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      –ü–û–ö–£–ü–ö–ê (payment.py)                           ‚îÇ
‚îÇ  Callback: check_payment                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚îú‚îÄ 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ YooKassa
          ‚îÇ
          ‚îú‚îÄ 2. –ï—Å–ª–∏ is_paid:
          ‚îÇ    ‚îú‚îÄ add_tokens(user_id, tokens)
          ‚îÇ    ‚îî‚îÄ _process_referral_commission()
          ‚îÇ         ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ referral_enabled
          ‚îÇ         ‚îú‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ referred_by
          ‚îÇ         ‚îú‚îÄ –†–∞—Å—á—ë—Ç earnings
          ‚îÇ         ‚îú‚îÄ add_referral_balance()
          ‚îÇ         ‚îú‚îÄ add_tokens() (—Ä–µ—Ñ–µ—Ä–µ—Ä—É)
          ‚îÇ         ‚îî‚îÄ log_referral_earning()
          ‚îÇ
          ‚îî‚îÄ 3. –ü–æ–∫–∞–∑ —É—Å–ø–µ—Ö–∞
```

---

## üíæ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –î–†–£–ì–û–ô –ü–†–û–ï–ö–¢

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

**1. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```
aiogram>=3.0
aiosqlite
python-dotenv
```

**2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:**
```
database/models.py    # SQL-—Å—Ö–µ–º—ã (4 –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
database/db.py        # –ú–µ—Ç–æ–¥—ã (~25 –º–µ—Ç–æ–¥–æ–≤)
handlers/referral.py  # –ü–æ–ª–Ω—ã–π handler
states/fsm.py         # ReferralStates
```

**3. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤:**
```
config.py            # –î–æ–±–∞–≤–∏—Ç—å BOT_USERNAME
user_start.py        # –û–±–Ω–æ–≤–∏—Ç—å profile_callback()
payment.py           # –î–æ–±–∞–≤–∏—Ç—å _process_referral_commission()
keyboards/inline.py  # –î–æ–±–∞–≤–∏—Ç—å 4 –∫–Ω–æ–ø–∫–∏ –≤ get_profile_keyboard()
utils/texts.py       # –î–æ–±–∞–≤–∏—Ç—å PROFILE_WITH_REFERRAL_TEXT
main.py              # –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å referral.router
```

### –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ `models.py` —Å–æ–∑–¥–∞–Ω–∏–µ 4 —Ç–∞–±–ª–∏—Ü
2. –î–æ–±–∞–≤–∏—Ç—å DEFAULT_SETTINGS (7 –Ω–∞—Å—Ç—Ä–æ–µ–∫)
3. –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
4. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ `db.py` (—Å–µ–∫—Ü–∏—è REFERRAL METHODS)

**–≠—Ç–∞–ø 2: Handlers**
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `handlers/referral.py` —Ü–µ–ª–∏–∫–æ–º
2. –û–±–Ω–æ–≤–∏—Ç—å `user_start.py`:
   - –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PROFILE_WITH_REFERRAL_TEXT
   - –û–±–Ω–æ–≤–∏—Ç—å profile_callback()
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ start_command()
3. –û–±–Ω–æ–≤–∏—Ç—å `payment.py`:
   - –î–æ–±–∞–≤–∏—Ç—å `_convert_earnings_to_tokens()`
   - –î–æ–±–∞–≤–∏—Ç—å `_process_referral_commission()`
   - –í—ã–∑–≤–∞—Ç—å –≤ `check_payment()`

**–≠—Ç–∞–ø 3: UI**
1. –î–æ–±–∞–≤–∏—Ç—å 4 –∫–Ω–æ–ø–∫–∏ –≤ `keyboards/inline.py`
2. –î–æ–±–∞–≤–∏—Ç—å ReferralStates –≤ `states/fsm.py`
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—ã –≤ `utils/texts.py`

**–≠—Ç–∞–ø 4: –ö–æ–Ω—Ñ–∏–≥**
1. –î–æ–±–∞–≤–∏—Ç—å BOT_USERNAME –≤ `config.py`
2. –î–æ–±–∞–≤–∏—Ç—å –≤ .env —Ñ–∞–π–ª
3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å router –≤ `main.py`

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
- [ ] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π referral_code
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –¥–æ–±–∞–≤–ª—è–µ—Ç +2 –æ–±–æ–∏–º
- [ ] referred_by –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è
- [ ] referrals_count —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —É —Ä–µ—Ñ–µ—Ä–µ—Ä–∞

**–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç –ø–æ–∫—É–ø–æ–∫:**
- [ ] –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `_process_referral_commission()`
- [ ] –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç (10% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- [ ] –†—É–±–ª–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ referral_balance
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π balance
- [ ] –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ referral_earnings
- [ ] –ï—Å–ª–∏ referred_by –ø—É—Å—Ç–æ–π ‚Äî –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

**–û–±–º–µ–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–∞–∫—Å–∏–º—É–º –ø–æ –∫—É—Ä—Å—É
- [ ] –ù–µ–ª—å–∑—è –æ–±–º–µ–Ω—è—Ç—å –±–æ–ª—å—à–µ –±–∞–ª–∞–Ω—Å–∞
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è
- [ ] –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ referral_exchanges
- [ ] /all –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç –≤—Å—é —Å—É–º–º—É

**–í—ã–≤–æ–¥ –¥–µ–Ω–µ–≥:**
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã (500 —Ä—É–±)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
- [ ] –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ referral_payouts
- [ ] –ë–∞–ª–∞–Ω—Å –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è (—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É)
- [ ] –ó–∞—è–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- [ ] –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–¥–º–∏–Ω–æ–º —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è

**–†–µ–∫–≤–∏–∑–∏—Ç—ã:**
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã (16-19 —Ü–∏—Ñ—Ä)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7XXXXXXXXXX)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è YooMoney (11-15 —Ü–∏—Ñ—Ä)
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ payment_method + payment_details
- [ ] –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏

**–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π:**
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∑–∞—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –æ–±–º–µ–Ω—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—ã–ø–ª–∞—Ç—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
- [ ] –î–∞—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°—É–º–º—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–æ–±–µ–ª–∞–º–∏

---

## üö® –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

**1. –û—à–∏–±–∫–∞: "Field referral_code doesn't exist"**
```
–ü—Ä–∏—á–∏–Ω–∞: –ë–∞–∑–∞ —Å—Ç–∞—Ä–∞—è, –ø–æ–ª—è –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
–†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é ALTER TABLE
```

**2. –û—à–∏–±–∫–∞: "BOT_USERNAME not found"**
```
–ü—Ä–∏—á–∏–Ω–∞: –ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è –±–æ—Ç–∞ –≤ config
–†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –≤ .env:
BOT_USERNAME=your_bot_username
```

**3. –û—à–∏–±–∫–∞: "Handler not found for callback referral_history"**
```
–ü—Ä–∏—á–∏–Ω–∞: Router –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
–†–µ—à–µ–Ω–∏–µ: –í main.py –¥–æ–±–∞–≤–∏—Ç—å:
from handlers import referral
dp.include_router(referral.router)
```

**4. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**
```
–ü—Ä–∏—á–∏–Ω–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏
–ü—Ä–∞–≤–∏–ª—å–Ω–æ: t.me/bot_username?start=ref_ABC12345
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: t.me/@bot_username?start=ref_ABC12345 (–ª–∏—à–Ω—è—è @)
```

**5. –ö–æ–º–∏—Å—Å–∏—è –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è**
```
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. referral_enabled = "1" –≤ settings
2. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–æ referred_by
3. commission_percent > 0
4. –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å "[REFERRAL]" –∑–∞–ø–∏—Å–∏
```

---

## üîß –†–ê–°–®–ò–†–ï–ù–ò–ï –ò –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä: –ù–∞—á–∏—Å–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Ä—É–±–ª–∏, –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π**

–í `payment.py` –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫:
```python
async def _process_referral_commission(...):
    await db.add_referral_balance(referrer_id, earnings)  # ‚úÖ –†—É–±–ª–∏
    
    # ‚ùå –£–ë–†–ê–¢–¨ –ö–û–ù–í–ï–†–¢–ê–¶–ò–Æ –í –ì–ï–ù–ï–†–ê–¶–ò–ò
    # tokens_to_give = await _convert_earnings_to_tokens(earnings)
    # if tokens_to_give > 0:
    #     await db.add_tokens(referrer_id, tokens_to_give)
    
    # –í –ª–æ–≥–µ —É–∫–∞–∑–∞—Ç—å tokens_given=0
    await db.log_referral_earning(..., tokens=0)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –∫–æ–º–∏—Å—Å–∏–∏

**–ü—Ä–∏–º–µ—Ä: –†–∞–∑–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤**

–í `payment.py`:
```python
async def _process_referral_commission(...):
    referrer = await db.get_user(referrer_id)
    referrals_count = referrer.get('referrals_count', 0)
    
    # –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —à–∫–∞–ª–∞
    if referrals_count >= 50:
        commission_percent = 20
    elif referrals_count >= 20:
        commission_percent = 15
    elif referrals_count >= 5:
        commission_percent = 12
    else:
        commission_percent = 10
    
    earnings = int(amount * commission_percent / 100)
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

---

## üêõ –û–¢–õ–ê–î–ö–ê –ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ payment.py:**

```python
logger.info(f"[REFERRAL] –†–∞—Å—á—ë—Ç: {amount} —Ä—É–± * {commission_percent}% = {earnings} —Ä—É–±")
logger.info(f"[REFERRAL] –ù–∞—á–∏—Å–ª–µ–Ω–æ {earnings} —Ä—É–± –Ω–∞ —Ä–µ—Ñ. –±–∞–ª–∞–Ω—Å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ {referrer_id}")
logger.info(f"[REFERRAL] –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: {earnings} —Ä—É–± = {tokens_to_give} –≥–µ–Ω–µ—Ä–∞—Ü–∏–π")
logger.info(f"[REFERRAL] ‚úÖ –ó–∞–ø–∏—Å—å –≤ referral_earnings —Å–æ–∑–¥–∞–Ω–∞")
```

**–ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º:**
```bash
# –í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
grep "\[REFERRAL\]" bot.log

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
grep "user_id: 123456" bot.log | grep REFERRAL

# –û—à–∏–±–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
grep "Failed to process referral commission" bot.log
```

### SQL-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
SELECT user_id, username, referrals_count, referral_balance, referral_total_earned
FROM users WHERE referrals_count > 0;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
SELECT * FROM referral_earnings ORDER BY created_at DESC LIMIT 10;

-- –û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–ø–ª–∞—Ç—ã
SELECT u.username, p.amount, p.requested_at
FROM referral_payouts p
JOIN users u ON p.user_id = u.user_id
WHERE p.status = 'pending';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–µ–π
SELECT 
    u1.user_id as referrer_id,
    u1.username as referrer_name,
    u1.referrals_count,
    u2.user_id as referred_id,
    u2.username as referred_name
FROM users u1
LEFT JOIN users u2 ON u2.referred_by = u1.user_id
WHERE u1.referrals_count > 0;
```

---

## üí° BEST PRACTICES

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤–≤–æ–¥:**
```python
# –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
card = re.sub(r'[^\d]', '', input)
if len(card) not in [16, 18, 19]:
    return error

# –¢–µ–ª–µ—Ñ–æ–Ω
if len(phone) != 12 or not phone.startswith('+7'):
    return error
```

‚úÖ **–ú–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:**
```python
# –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –≤ –ª–æ–≥–∞—Ö
logger.info(f"–í—ã–ø–ª–∞—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É ****{details[-4:]}")
```

‚úÖ **–ü—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏:**
```python
# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ü–ï–†–ï–î —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
balance = await db.get_referral_balance(user_id)
if amount > balance:
    return error
```

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_users_referral_code ON users(referral_code);
CREATE INDEX idx_users_referred_by ON users(referred_by);
CREATE INDEX idx_earnings_referrer ON referral_earnings(referrer_id);
CREATE INDEX idx_payouts_status ON referral_payouts(status);
```

‚úÖ **–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä–∫–∏:**
```python
# –ù–µ SELECT *, –∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–ª—è
# –ù–µ –≤—Å–µ –∑–∞–ø–∏—Å–∏, –∞ LIMIT
earnings = await db.get_user_referral_earnings(user_id)  # LIMIT 20 –≤–Ω—É—Ç—Ä–∏
```

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```python
# –ü–ª–æ—Ö–æ
"Error: insufficient funds"

# –•–æ—Ä–æ—à–æ
"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\n"
f"–î–æ—Å—Ç—É–ø–Ω–æ: {balance} —Ä—É–±.\n"
f"–ú–∏–Ω–∏–º—É–º –¥–ª—è –≤—ã–≤–æ–¥–∞: {min_payout} —Ä—É–±."
```

‚úÖ **–í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è:**
```python
text = (
    "üíé **–û–ë–ú–ï–ù –ù–ê –ì–ï–ù–ï–†–ê–¶–ò–ò**\n\n"  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∂–∏—Ä–Ω—ã–π
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"             # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    f"üí∞ –ë–∞–ª–∞–Ω—Å: **{balance} —Ä—É–±.**\n"  # –í–∞–∂–Ω–æ–µ –∂–∏—Ä–Ω–æ–µ
    f"–ö—É—Ä—Å: {rate} —Ä—É–±/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è\n"    # –û–±—ã—á–Ω–æ–µ
)
```

‚úÖ **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:**
```python
# –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥:
# - –í—ã–≤–æ–¥–æ–º –¥–µ–Ω–µ–≥
# - –û–±–º–µ–Ω–æ–º –±–∞–ª–∞–Ω—Å–∞
# - –ò–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
```

---

## üì¶ –ê–ö–¢–£–ê–õ–¨–ù–´–ï –§–ê–ô–õ–´ –í GITHUB

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**Database:**
- `bot/database/models.py` - SQL-—Å—Ö–µ–º—ã –∏ –∑–∞–ø—Ä–æ—Å—ã
- `bot/database/db.py` - –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –ë–î

**Handlers:**
- `bot/handlers/user_start.py` - –ü—Ä–æ—Ñ–∏–ª—å –∏ —Å—Ç–∞—Ä—Ç
- `bot/handlers/payment.py` - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π
- `bot/handlers/referral.py` - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
- `bot/handlers/admin.py` - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**States:**
- `bot/states/fsm.py` - ReferralStates, AdminStates

**Config:**
- `bot/config.py` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (BOT_USERNAME)

**Main:**
- `bot/main.py` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- [x] –°–æ–∑–¥–∞–Ω–∏–µ 4 –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –ë–î
- [x] –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã users
- [x] 7 –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ settings
- [x] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
- [x] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –æ—Ç –ø–æ–∫—É–ø–æ–∫
- [x] –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä—É–±–ª–µ–π –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –û–±–º–µ–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [x] –ó–∞–ø—Ä–æ—Å –≤—ã–ø–ª–∞—Ç—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- [x] 4 —Å–ø–æ—Å–æ–±–∞ –ø—Ä–∏–≤—è–∑–∫–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∫–∞—Ä—Ç—ã, YooMoney
- [x] –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
- [x] –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (earnings, exchanges, payouts)
- [x] –ü—Ä–æ—Ñ–∏–ª—å —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- [x] 4 –∫–Ω–æ–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- [x] FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ñ–ª–æ—É
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- [x] –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–±–∞–∑–æ–≤–∞—è)

---

## üéì FAQ

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?**  
A: –î–∞. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ `custom_commission_percent` –≤ —Ç–∞–±–ª–∏—Ü—É users. –í `_process_referral_commission()` —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —ç—Ç–æ –ø–æ–ª–µ, –µ—Å–ª–∏ NULL ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∏–∑ settings.

**Q: –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (2 —É—Ä–æ–≤–Ω—è)?**  
A: –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ `referrer_level_2` –≤ users. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞, –∞ –∑–∞—Ç–µ–º –µ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (referred_by). –ù–∞—á–∏—Å–ª—è–π—Ç–µ –º–µ–Ω—å—à–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—Ç–æ—Ä–æ–º—É —É—Ä–æ–≤–Ω—é.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –≤—ã–ø–ª–∞—á–∏–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API –±–∞–Ω–∫–∞?**  
A: –î–∞. –í `confirm_payout()` –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤—ã–∑—ã–≤–∞–π—Ç–µ API –±–∞–Ω–∫–∞/–ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –∑–∞—Ç–µ–º —Å—Ä–∞–∑—É –º–µ–Ω—è–π—Ç–µ status –Ω–∞ 'completed'.

**Q: –ö–∞–∫ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –¥–æ N —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤?**  
A: –í `request_payout()` –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É:
```python
referrals_count = user_data.get('referrals_count', 0)
if referrals_count < 5:
    await callback.answer("‚ö†Ô∏è –ú–∏–Ω–∏–º—É–º 5 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞")
    return
```

**Q: –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –ª–∏–º–∏—Ç –Ω–∞ –≤—ã–≤–æ–¥ –≤ –¥–µ–Ω—å?**  
A: –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ `last_payout_date` –∏ `payouts_today` –≤ users. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≤—ã–ø–ª–∞—Ç—ã.

---

## üìû SUPPORT

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–õ–æ–≥–∏:** `grep REFERRAL bot.log`
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** SQL-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (—Å–º. —Ä–∞–∑–¥–µ–ª –≤—ã—à–µ)
3. **Callback handlers:** –í—Å–µ –ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
4. **States:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –æ—á–∏—â–µ–Ω—ã
5. **Settings:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã –ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ë–î

**–¢–∏–ø–∏—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏:**
```
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ Python
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å handlers –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å settings –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ users
```

---

## üìù CHANGELOG

**v1.0.0 (03.12.2025):**
- ‚úÖ –ë–∞–∑–æ–≤–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ % –æ—Ç –ø–æ–∫—É–ø–æ–∫
- ‚úÖ –í—ã–≤–æ–¥ –¥–µ–Ω–µ–≥ (4 —Å–ø–æ—Å–æ–±–∞)
- ‚úÖ –û–±–º–µ–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–±–∞–∑–æ–≤–∞—è)

---

## üé¨ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ:**

‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å 4 –Ω–æ–≤—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏  
‚úÖ 25+ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏  
‚úÖ –ü–æ–ª–Ω—ã–π UI —Å 4 –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π  
‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ % –æ—Ç –ø–æ–∫—É–ø–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ  
‚úÖ –í—ã–≤–æ–¥ –¥–µ–Ω–µ–≥ —Å —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∞–¥–º–∏–Ω–æ–º  
‚úÖ –û–±–º–µ–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π  
‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ settings –≥–∏–±–∫–∏–µ  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ  

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production –∏ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è!**

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞: 03.12.2025*  
*–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: 1.0.0*  
*–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/severand/InteriorBot-v2*
